#!/bin/bash

# Nexus Repository Manager Installation Script - BULLETPROOF VERSION
# For Amazon Linux 2023 on t3.small EC2 instance
# This version handles all extraction quirks and validates each step

set -e

echo "======================================"
echo "Nexus Installation Script - Final Version"
echo "======================================"

# Update system
echo "Updating system packages..."
sudo yum update -y

# Install Java 8 (Nexus requirement)
echo "Installing Java 8..."
sudo yum install -y java-1.8.0-amazon-corretto-devel

# Verify Java installation
echo "Java version:"
java -version

# Create nexus user
echo "Creating nexus user..."
sudo useradd -r -m -U -d /opt/nexus-home -s /bin/bash nexus 2>/dev/null || echo "User nexus already exists"

# Download Nexus with fallback URLs
echo "Downloading Nexus Repository Manager..."
NEXUS_VERSION="3.70.1-02"

# Primary and fallback download URLs
URLS=(
    "https://download.sonatype.com/nexus/3/nexus-${NEXUS_VERSION}-unix.tar.gz"
    "https://sonatype-download.global.ssl.fastly.net/repository/downloads-prod-group/3/nexus-${NEXUS_VERSION}-unix.tar.gz"
    "https://download.sonatype.com/nexus/3/latest-unix.tar.gz"
)

download_success=false
for url in "${URLS[@]}"; do
    echo "Trying to download from: $url"
    if wget --timeout=30 --tries=3 "$url" -O /tmp/nexus.tar.gz 2>/dev/null; then
        download_success=true
        echo "Download successful!"
        break
    else
        echo "Failed to download from $url, trying next source..."
    fi
done

if [ "$download_success" = false ]; then
    echo "ERROR: Could not download Nexus from any source."
    exit 1
fi

# Extract to temp location
echo "Extracting Nexus to temporary location..."
mkdir -p /tmp/nexus-install
cd /tmp/nexus-install
tar -xzf /tmp/nexus.tar.gz

# Find the extracted nexus directory (exclude the parent directory itself)
NEXUS_EXTRACTED=$(find /tmp/nexus-install -mindepth 1 -maxdepth 1 -type d -name "nexus-*" | head -1)

if [ -z "$NEXUS_EXTRACTED" ]; then
    echo "ERROR: Could not find extracted Nexus directory"
    ls -la /tmp/nexus-install
    exit 1
fi

echo "Found extracted Nexus at: $NEXUS_EXTRACTED"

# Move to final location
echo "Moving Nexus to /opt/nexus..."
# Remove existing /opt/nexus if it exists
sudo rm -rf /opt/nexus
sudo mv "$NEXUS_EXTRACTED" /opt/nexus

# Verify critical files exist
if [ ! -f /opt/nexus/bin/nexus ]; then
    echo "ERROR: /opt/nexus/bin/nexus not found!"
    echo "Contents of /opt/nexus:"
    ls -la /opt/nexus
    exit 1
fi

echo "✓ Nexus binary found at /opt/nexus/bin/nexus"

# Create sonatype-work directory
echo "Creating sonatype-work directory..."
sudo mkdir -p /opt/sonatype-work

# Set ownership
echo "Setting ownership..."
sudo chown -R nexus:nexus /opt/nexus
sudo chown -R nexus:nexus /opt/sonatype-work

# Configure JVM memory for t3.small (2GB RAM)
echo "Configuring JVM memory settings for t3.small..."
sudo tee /opt/nexus/bin/nexus.vmoptions > /dev/null << 'EOF'
-Xms512m
-Xmx1024m
-XX:MaxDirectMemorySize=512m
-XX:+UnlockDiagnosticVMOptions
-XX:+LogVMOutput
-XX:LogFile=../sonatype-work/nexus3/log/jvm.log
-XX:-OmitStackTraceInFastThrow
-Djava.net.preferIPv4Stack=true
-Dkaraf.home=.
-Dkaraf.base=.
-Dkaraf.etc=etc/karaf
-Djava.util.logging.config.file=etc/karaf/java.util.logging.properties
-Dkaraf.data=/opt/sonatype-work/nexus3
-Dkaraf.log=/opt/sonatype-work/nexus3/log
-Djava.io.tmpdir=/opt/sonatype-work/nexus3/tmp
EOF

sudo chown nexus:nexus /opt/nexus/bin/nexus.vmoptions
echo "✓ JVM options configured"

# Configure Nexus to run as nexus user
echo "Configuring Nexus to run as nexus user..."
sudo sed -i 's/#run_as_user=""/run_as_user="nexus"/' /opt/nexus/bin/nexus.rc
echo "✓ Run as user configured"

# Make nexus executable
sudo chmod +x /opt/nexus/bin/nexus

# Create systemd service
echo "Creating systemd service..."
sudo tee /etc/systemd/system/nexus.service > /dev/null << 'EOF'
[Unit]
Description=Nexus Repository Manager
After=network.target

[Service]
Type=forking
LimitNOFILE=65536
ExecStart=/opt/nexus/bin/nexus start
ExecStop=/opt/nexus/bin/nexus stop
User=nexus
Restart=on-abort
TimeoutSec=600

[Install]
WantedBy=multi-user.target
EOF

echo "✓ Systemd service created"

# Reload systemd
echo "Reloading systemd..."
sudo systemctl daemon-reload

# Enable service
echo "Enabling Nexus service..."
sudo systemctl enable nexus

# Start service
echo "Starting Nexus service..."
sudo systemctl start nexus

# Wait and check status
sleep 5
echo ""
echo "======================================"
echo "Checking service status..."
echo "======================================"
sudo systemctl status nexus --no-pager -l || true

# Configure firewall (if firewalld is running)
if sudo systemctl is-active --quiet firewalld; then
    echo "Configuring firewall..."
    sudo firewall-cmd --permanent --add-port=8081/tcp
    sudo firewall-cmd --reload
fi

echo ""
echo "======================================"
echo "Installation Complete!"
echo "======================================"
echo ""
echo "Nexus is starting up. This may take 2-3 minutes."
echo ""
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "YOUR_EC2_IP")
echo "Access Nexus at: http://${PUBLIC_IP}:8081"
echo ""
echo "To check if Nexus is ready:"
echo "  sudo tail -f /opt/sonatype-work/nexus3/log/nexus.log"
echo ""
echo "Once started, retrieve the initial admin password:"
echo "  sudo cat /opt/sonatype-work/nexus3/admin.password"
echo ""
echo "Default credentials:"
echo "  Username: admin"
echo "  Password: (from admin.password file)"
echo ""
echo "Useful commands:"
echo "  sudo systemctl status nexus   - Check status"
echo "  sudo systemctl restart nexus  - Restart service"
echo "  sudo systemctl stop nexus     - Stop service"
echo "  sudo journalctl -u nexus -f   - View service logs"
echo ""
echo "IMPORTANT: Make sure your EC2 security group allows inbound traffic on port 8081"
echo "======================================"

# Clean up
rm -f /tmp/nexus.tar.gz
rm -rf /tmp/nexus-install

echo ""
echo "Validation checks:"
echo "✓ Nexus binary: $(ls -lh /opt/nexus/bin/nexus | awk '{print $9}')"
echo "✓ Service file: $(ls -lh /etc/systemd/system/nexus.service | awk '{print $9}')"
echo "✓ JVM options: $(ls -lh /opt/nexus/bin/nexus.vmoptions | awk '{print $9}')"
echo ""
echo "Installation script completed successfully!"